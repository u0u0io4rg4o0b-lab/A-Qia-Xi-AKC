<!DOCTYPE html>
<html lang="en">
  <head>
    <meta name="akc-auth" content="strict" />

    <!-- å»ºè­°ï¼šæ‰€æœ‰é é¢ <head> æœ€å‰é¢éƒ½åŠ é€™è¡Œ -->
    <script src="JS/config.js"></script>
    <meta charset="UTF-8" />
    <title>é‘„é€ åœ–æ›¸è­‰ NFT</title>
    <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
    <script src="JS/checkAccess.js"></script>
    <!-- ç¢ºä¿å…ˆè¼‰å…¥ -->
    <script src="JS/wallet.js"></script>
    <link
      href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css"
      rel="stylesheet"
    />
  </head>
  <body class="bg-gray-100 flex flex-col items-center justify-center h-screen">
    <div class="bg-white shadow-lg rounded-xl p-6 w-full max-w-md text-center">
      <h1 class="text-2xl font-bold mb-4">ğŸ“ é‘„é€ ä½ çš„åœ–æ›¸è­‰ NFT</h1>
      <p class="mb-6 text-gray-600">é€™æ˜¯ä½ é€²å…¥é˜¿å¡è¥¿åœ–æ›¸é¤¨çš„èº«ä»½è­˜åˆ¥è­‰ã€‚</p>
      <button
        id="mintButton"
        class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition"
      >
        é»æ“Šé‘„é€ 
      </button>
      <p id="status" class="mt-4 text-sm text-gray-500"></p>
    </div>

    <script>
      document
        .getElementById('mintButton')
        .addEventListener('click', async () => {
          const provider = new ethers.providers.Web3Provider(
            window.ethereum,
            'any'
          );
          await window.ethereum.request({ method: 'eth_requestAccounts' });

          const signer = provider.getSigner();
          const network = await provider.getNetwork();
          console.log('ç›®å‰ç¶²è·¯ç‚º', network.name);
          const EXPECTED = window.AKC_CONFIG.CHAIN_ID;
          if (network.chainId !== EXPECTED) {
            document.getElementById(
              'status'
            ).textContent = `âš ï¸ è«‹åˆ‡åˆ°æ­£ç¢ºç¶²è·¯ï¼ˆç•¶å‰ ${network.chainId}ï¼‰`;
            return;
          }
          if (!window.AKC_CONFIG?.CONTRACT || !window.AKC_CONFIG?.CHAIN_ID) {
            document.getElementById('status').textContent =
              'âš ï¸ è¨­å®šæœªè¼‰å…¥ï¼Œè«‹é‡æ–°æ•´ç†ï¼ˆconfig.jsï¼‰ã€‚';
            return;
          }

          const contract = new ethers.Contract(
            window.AKC_CONFIG.CONTRACT,
            ['function mintSelf() public'],
            signer
          );

          try {
            const btn = document.getElementById('mintButton');
            btn.disabled = true;
            btn.classList.add('opacity-60', 'cursor-not-allowed');

            document.getElementById('status').textContent =
              'â³ æ­£åœ¨ç™¼é€äº¤æ˜“ä¸­...';
            const tx = await contract.mintSelf();
            await tx.wait();
            document.getElementById('status').textContent =
              'âœ… é‘„é€ æˆåŠŸï¼å³å°‡è·³è½‰...';
            setTimeout(() => {
              window.location.href = 'profile.html';
            }, 2000);
          } catch (err) {
            console.error(err);
            document.getElementById('status').textContent =
              'âŒ é‘„é€ å¤±æ•—ï¼Œè«‹ç¨å¾Œé‡è©¦ã€‚';
            const m = String(err?.message || err);
            const nice = /already minted|balanceOf/.test(m)
              ? 'âŒ ä½ å·²ç¶“æ“æœ‰ 1 æšï¼Œç„¡æ³•å†æ¬¡é‘„é€ '
              : /user rejected|denied|rejected/.test(m)
              ? 'âŒ ä½ å–æ¶ˆäº†äº¤æ˜“'
              : 'âŒ é‘„é€ å¤±æ•—ï¼Œè«‹ç¨å¾Œé‡è©¦';
            document.getElementById('status').textContent = nice;
          } finally {
            const btn = document.getElementById('mintButton');
            btn.disabled = false;
            btn.classList.remove('opacity-60', 'cursor-not-allowed');
          }
        });
    </script>
  </body>
</html>
